# JSON Tag Test App for Android

This is a Test App to showcase how [JSON Tag](https://github.com/floriangoetting/json-tag) can be used with a native Android App to send data to a server-side Google Tag Manager Instance which is running [JSON Client](https://github.com/floriangoetting/json-client).

The JSON Client receives JSON Payloads and makes the data available in the Event Data. The built-in ID Service creates long lasting server-side set (HTTP-Only) cookies for visitor identification.

For a detailed guide please check the [Blogpost about JSON Tag & JSON Client](https://www.floriangoetting.de/en/json-tag-json-client-a-flexible-first-party-tracking-solution-for-ssgtm/?utm_source=github&utm_medium=social&utm_campaign=ssgtm-json-tag-json-client-first-party-tracking&utm_content=json-tag-test-app-android-repo).

Please note that this is just a simple sample App and is not meant to be used in production. However it should be a good starting point to get an idea how JSON Tag can be used with a Native App and could help App Developers in the initial implementation. As I am not an Android Developer, the code can be optimized further for sure :P

## How to install the Test App
1. Download and Install Android Studio: https://developer.android.com/studio
2. Download and Install Git: https://git-scm.com/downloads
3. Clone the Project from Git in Android Studio under File -> New -> Project from Version Control by entering the repository url (https://github.com/floriangoetting/json-tag-test-app-android) and clicking on "clone"
4. Update the sample tracker config from line 128 in the MainActivity.kt file (app/src/main/java/com/floriangoetting/jsontagtestapp/MainActivity.kt) to configure your sstEndpoint, webview URL, cookie names and more
5. Run the App using a real Android device which is connected to your computer or by running it on an emulated device by clicking the green play button on the top menu

## How to debug the Native App and Webview Tracking Requests
To debug the tracking calls generated by the Test App, the easiest way is to set the GTM Server Preview Header in the tracker configuration. This enables you to see the native App tracking calls in the ssGTM Preview Mode.

### Debug Native App Requests using the configuration Option and ssGTM Preview Mode
To enable the ssGTM Preview Mode, follow these steps:
1. Start the preview mode in your ssGTM Instance
2. Click the three dots menu on the top right and select "Send requests manually"
3. Copy the X-Gtm-Server-Preview HTTP header value
4. Go to the tracker configuration in Android Studio in the MainActivity.kt file (app/src/main/java/com/floriangoetting/jsontagtestapp/MainActivity.kt), uncomment the "tracker.setGtmServerPreviewHeader" option and update the gtm server preview header value with the one you copied in step 3
5. Run the App again to trigger a new Build and check the ssGTM Preview Mode to see the tracking requests

### Debug Webview App Requests using Charles Proxy and ssGTM Preview Mode
Unfortunately this method only works for the native Tracking calls but not for Tracking Calls which are happening in the App Webviews. If you want to see the App Webview Tracking calls in the ssGTM preview mode as well, an option would be to use a Network Proxy like the charles proxy to add the X-Gtm-Server-Preview HTTP header dynamically to the tracking calls. If this method is used, it is not required to use the tracker configuration for the server preview header.

To enable the dynamic addition of the X-Gtm-Server-Preview HTTP header in Charles proxy follow these steps:
1. Install and configure Charles proxy to proxy the requests from your test device: https://www.charlesproxy.com/download/latest-release/
2. Add a new rewrite Rule in Charles Proxy under Tools -> Rewrite -> Add
3. Add a new location with the host and path of your tracking calls which are sent to your server side GTM Instance
4. Add a rule action and select "Add header" as type
5. Leave the match section empty and under replace set "X-Gtm-Server-Preview" as Name and your X-Gtm-Server-Preview HTTP header value (copied from the ssGTM Preview Mode) as the value
6. Save the rule and make sure that rewrites are enabled
7. Trigger tracking calls again and check the ssGTM Preview Mode to see the tracking requests

## Usage and Configuration Options
The tracker class is used to configure the tracking, building the tracking calls handling a queue and more. To create a new tracker instance, the application context, the sstEndpoint and the JSON Client path need to be set. The other settings can be set either directly in the constructor or using set Methods.

It is possible to track events using the tracker.trackEvent Method (see methods below) before the tracker had been initialized with the tracker.initialize() method. In this case the tracking events are queued and sent when the tracker.initialize() method is called. This can be helpful when you want to wait for consent before sending the network requests.

Example:
```kotlin
 // tracker config
val sstEndpoint = "https://sst.floriangoetting.de"

tracker = Tracker(this, sstEndpoint, "/data", sessionTimeoutInMinutes = 30, launchTimeoutMinutes = 5)
val globalEventData = mapOf(
    "app" to appData,
    "device" to deviceData,
    "settings" to settingsData,
    "consent" to consentData
)
tracker.setGlobalEventData(globalEventData)
tracker.setDeviceIdCookieName("fgId")
tracker.setSessionIdCookieName("web_session_id")
//tracker.setGtmServerPreviewHeader("ZW52LTN8ZkNTSWNWLUttdzUwTGtzSVg1UlZBZ3wxOTcyYzI3NmMxOTNmNzIyM2M1YWY=")
tracker.setWebviewUrl("https://www.floriangoetting.de/en/blogposts/")
tracker.initialize()
// end of tracker config
```

### Configuration Options
#### context: Context (mandatory)
Context is mandatory in order to manage the shared preferences which are used to store information about the application lifecycle and cookie values.

#### endpoint: String (mandatory)
Endpoint is a mandatory setting and needs to point to the hostname of your server side Google Tag Manager instance.

#### path: String (mandatory)
Endpoint is a mandatory setting and needs to point to the path which is configured in your JSON Client.

#### gtmServerPreviewHeader: String (optional)
This optional setting let's you set the X-Gtm-Server-Preview HTTP header value from the Server Side Google Tag Manager Preview Mode. See the section above for more details. This value changes in every ssGTM Debug Session and needs to be updated for every test.

#### deviceIdCookieName: String (optional)
This optional setting let's you define the device id cookie name you are using in JSON Client which is used to inject the device id cookie in the webview. If no value is specified the default value "fp_device_id" is used.

#### sessionIdCookieName: String (optional)
This optional setting let's you define the session id cookie name you are using in JSON Client which is used to inject the session id cookie in the webview. If no value is specified the default value "fp_session_id" is used.

#### webviewUrl: String (optional)
This optional setting let's you define the webview url which is opened when you navigate to the webview tab in the Test App. It can be used to test how the device and session ids are passed to the webview to keep using the same ids in the webview tracking.

#### sessionTimeoutInMinutes: Int (optional)
This optional setting let's you configure the timeout in minutes the device needs to be in the background or inactive, to set a new session id.

#### launchTimeoutInMinutes: Int (optional)
The test app includes automatic tracking of Installs and Launches. This optional setting let's you configure the timeout in minutes the device needs to be in the background or inactive, to send a new launch event. When the App is launched initially, a "first_launch" event is tracked. For every launch after the "launchTimeoutInMinutes" a "launch" event is tracked.

### Tracker Methods
### trackEvent(eventName: String, eventType: EventType, eventData: Map<String, Any>)
This method can be used to track an event. If the initialize() method had not been called yet, the event is added to a queue.

Possible event types are:
- VIEW
- LIFECYCLE
- CALLBACK
- ERROR
- GENERIC_ACTION
- IMPRESSION
- NON_INTERACTION

#### initialize()
This method should be called once the tracker had been configured and you want to start the data collection. In case events had been tracked before the initialization, the event queue is processed.

#### setGlobalEventData(data: Map<String, Any>)
This method can be used to set event data which should be present in every event including the Install and Launch tracking.

#### setGtmServerPreviewHeader(value: String?)
This method can be used to set the X-Gtm-Server-Preview HTTP header value from the Server Side Google Tag Manager Preview Mode.

#### setDeviceIdCookieName(name: String?)
This method can be used to set the device id cookie name you are using in JSON Client which is used to inject the device id cookie in the webview.

#### setSessionIdCookieName(name: String?)
This method can be used to set the session id cookie name you are using in JSON Client which is used to inject the session id cookie in the webview.

#### setWebviewUrl(url: String)
This method can be used to set the webview url which is opened when you navigate to the webview tab in the Test App. It can be used to test how the device and session ids are passed to the webview to keep using the same ids in the webview tracking.
