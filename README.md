# JSON Tag Test App for Android

This is a Test App to showcase how [JSON Tag](https://github.com/floriangoetting/json-tag) can be used with a native Android App to send data to a server-side Google Tag Manager Instance which is running [JSON Client](https://github.com/floriangoetting/json-client).

The JSON Client receives JSON Payloads and makes the data available in the Event Data. The built-in ID Service creates long lasting server-side set (HTTP-Only) cookies for visitor identification.

For a detailed guide please check the [Blogpost about JSON Tag & JSON Client](https://www.floriangoetting.de/en/json-tag-json-client-a-flexible-first-party-tracking-solution-for-ssgtm/?utm_source=github&utm_medium=social&utm_campaign=ssgtm-json-tag-json-client-first-party-tracking&utm_content=json-tag-test-app-android-repo).

Please note that this is just a simple sample App and is not meant to be used in production. However it should be a good starting point to get an idea how JSON Tag can be used with a Native App and could help App Developers in the initial implementation. As I am not an Android Developer, the code can be optimized further for sure :P

## How to install the Test App
1. Download and Install Android Studio: https://developer.android.com/studio
2. Download and Install Git: https://git-scm.com/downloads
3. Clone the Project from Git in Android Studio under File -> New -> Project from Version Control by entering the repository url (https://github.com/floriangoetting/json-tag-test-app-android) and clicking on "clone"
4. Update the sample tracker config from line 128 in the MainActivity.kt file (app/src/main/java/com/floriangoetting/jsontagtestapp/MainActivity.kt) to configure your sstEndpoint, webview URL, cookie names and more
5. Run the App using a real Android device which is connected to your computer or by running it on an emulated device by clicking the green play button on the top menu

## How to debug the Native App and Webview Tracking Requests
To debug the tracking calls generated by the Test App, the easiest way is to set the GTM Server Preview Header in the tracker configuration. This enables you to see the native App tracking calls in the ssGTM Preview Mode.

### Debug Native App Requests using the configuration Option and ssGTM Preview Mode
To enable the ssGTM Preview Mode, follow these steps:
1. Start the preview mode in your ssGTM Instance
2. Click the three dots menu on the top right and select "Send requests manually"
3. Copy the X-Gtm-Server-Preview HTTP header value
4. Go to the tracker configuration in Android Studio in the MainActivity.kt file (app/src/main/java/com/floriangoetting/jsontagtestapp/MainActivity.kt), uncomment the "tracker.setGtmServerPreviewHeader" option and update the gtm server preview header value with the one you copied in step 3
5. Run the App again to trigger a new Build and check the ssGTM Preview Mode to see the tracking requests

### Debug Webview App Requests using the configuration Option and ssGTM Preview Mode
It is also possible to debug Webview App Requests using the configuration option mentioned above. As a prerequisite it is required to configure JSON Tag in the Webview to set the x-gtm-server-preview header dynamically based on a cookie with the name of your choice.

To make it work, just follow these steps:
1. Make sure that JSON Client on your ssGTM is updated to the most recent version and is published.
2. Create a first party cookie variable in client side GTM with the name of your choice. For example "xgtmsp".
3. Open your JSON Tag Settings Variable and select the cookie variable in the "X-Gtm-Server-Preview Token" Field which you find in the Debugging Settings.
4. Do a test and create the cookie manually in your browser with a valid X-Gtm-Server-Preview value. Make sure that the header is added to the JSON Tag requests and is properly received by the server. If everything is fine publish the client side GTM container.
5. Go to the tracker configuration in Android Studio in the MainActivity.kt file (app/src/main/java/com/floriangoetting/jsontagtestapp/MainActivity.kt), uncomment the "tracker.setGtmServerPreviewHeader" option and update the gtm server preview header value.
6. Uncomment the "tracker.setGtmServerPreviewHeaderWebviewCookieName" as well and make sure the same cookie name as in your client side GTM is used here.
7. Run the App again to trigger a new Build and check the ssGTM Preview Mode to see the tracking requests you tiggered in the App Webview

## Usage and Configuration Options
The tracker class is used to configure the tracking, building the tracking calls handling a queue and more. To create a new tracker instance, the application context, the sstEndpoint and the JSON Client path need to be set. The other settings can be set either directly in the constructor or using set Methods.

It is possible to track events using the tracker.trackEvent Method (see methods below) before the tracker had been initialized with the tracker.initialize() method. In this case the tracking events are queued and sent when the tracker.initialize() method is called. This can be helpful when you want to wait for consent before sending the network requests.

Example:
```kotlin
 // tracker config
val sstEndpoint = "https://sst.floriangoetting.de"

tracker = Tracker(this, sstEndpoint, "/data", sessionTimeoutInMinutes = 30)
val globalEventData = mapOf(
    "app" to appData,
    "device" to deviceData,
    "settings" to settingsData,
    "consent" to consentData
)
tracker.setGlobalEventData(globalEventData)
tracker.setDeviceIdCookieName("fgId")
tracker.setSessionIdCookieName("web_session_id")
tracker.setGtmServerPreviewHeader("ZW52LTN8ZkNTSWNWLUttdzUwTGtzSVg1UlZBZ3wxOTdmMDI3YzZhM2RiYTVkNDY4MDQ=")
tracker.setGtmServerPreviewHeaderWebviewCookieName("xgtmsp")
tracker.setWebviewUrl("https://www.floriangoetting.de/en/blogposts/")
tracker.initialize()
// end of tracker config
```

### Configuration Options
#### context: Context (mandatory)
Context is mandatory in order to manage the shared preferences which are used to store information about the application lifecycle and cookie values.

#### endpoint: String (mandatory)
Endpoint is a mandatory setting and needs to point to the hostname of your server side Google Tag Manager instance.

#### path: String (mandatory)
Endpoint is a mandatory setting and needs to point to the path which is configured in your JSON Client.

#### gtmServerPreviewHeader: String (optional)
This optional setting let's you set the X-Gtm-Server-Preview HTTP header value from the Server Side Google Tag Manager Preview Mode. See the section above for more details. This value changes in every ssGTM Debug Session and needs to be updated for every test.

#### deviceIdCookieName: String (optional)
This optional setting let's you define the device id cookie name you are using in JSON Client which is used to inject the device id cookie in the webview. If no value is specified the default value "fp_device_id" is used.

#### sessionIdCookieName: String (optional)
This optional setting let's you define the session id cookie name you are using in JSON Client which is used to inject the session id cookie in the webview. If no value is specified the default value "fp_session_id" is used.

#### webviewUrl: String (optional)
This optional setting let's you define the webview url which is opened when you navigate to the webview tab in the Test App. It can be used to test how the device and session ids are passed to the webview to keep using the same ids in the webview tracking.

#### sessionTimeoutInMinutes: Int (optional)
This optional setting let's you configure the timeout in minutes the device needs to be in the background or inactive, to set a new session id.

### Tracker Methods
### trackEvent(eventName: String, eventType: EventType, eventData: Map<String, Any>)
This method can be used to track an event. If the initialize() method had not been called yet, the event is added to a queue.

Possible event types are:
- VIEW
- CALLBACK
- ERROR
- GENERIC_ACTION
- IMPRESSION
- NON_INTERACTION

#### initialize()
This method should be called once the tracker had been configured and you want to start the data collection. In case events had been tracked before the initialization, the event queue is processed.

#### setGlobalEventData(data: Map<String, Any>)
This method can be used to set event data which should be present in every event including the Install and Launch tracking.

#### setGtmServerPreviewHeader(value: String?)
This method can be used to set the X-Gtm-Server-Preview HTTP header value from the Server Side Google Tag Manager Preview Mode.

#### setGtmServerPreviewHeaderWebviewCookieName(value: String?)
This method can be used to set the X-Gtm-Server-Preview cookie name which should be used to inject the header into the webview.

#### setDeviceIdCookieName(name: String?)
This method can be used to set the device id cookie name you are using in JSON Client which is used to inject the device id cookie in the webview.

#### setSessionIdCookieName(name: String?)
This method can be used to set the session id cookie name you are using in JSON Client which is used to inject the session id cookie in the webview.

#### setWebviewUrl(url: String)
This method can be used to set the webview url which is opened when you navigate to the webview tab in the Test App. It can be used to test how the device and session ids are passed to the webview to keep using the same ids in the webview tracking.
